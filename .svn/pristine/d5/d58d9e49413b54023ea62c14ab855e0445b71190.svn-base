'use strict';
angular.module('admin.app').controller('LookupAdminController', 
    ['$scope', '$log', '$filter', '$templateCache', 'uiGridExporterConstants', 'uiGridConstants', 'lookupTypes', 'AdminLookupService', 'UiGridUtilService', 'ModalRowEdit',
    function ($scope, $log, $filter, $templateCache, uiGridExporterConstants, uiGridConstants, lookupTypes, AdminLookupService, UiGridUtilService, ModalRowEdit) {
        var vm = this;

        //UiGridUtilService.loadTemplate('ui-grid/selectionRowHeader');
        //UiGridUtilService.loadTemplate('ui-grid/selectionRowHeaderButtonsCanopi');

        // By default the accordion is open
        vm.searchAccordionOpen = true;

        // sort the lookup type values in ascending order
        vm.lookupTypes = $filter('orderBy')(lookupTypes, 'name');
        vm.uiGridExporterConstants = uiGridExporterConstants;

        // Load default values
        vm.lookupType = vm.lookupTypes[2];
        vm.mySlections = [];

        // Configure grid
        vm.gridOptions = {
            enableRowSelection: false,
            rowHeight: 45,
            //enableSelectAll: false,
            //enableHorizontalScrollbar: uiGridConstants.NEVER,
            //enableColumnMenus: false,
            //enableGridMenu: true,
            enableCellEditOnFocus: true,
            //multiSelect: false,
            //exporterCsvFilename: vm.lookupType.value + '.csv',
            //exporterMenuPdf: false,
            //exporterMenuCsv: false,
            //selectionRowHeaderWidth: '75',
            //gridMenuCustomItems: [
            //    {
            //      title: 'Hide Empty Columns',
            //      action: function () {
            //        vm.gridOptions.columnDefs[1].visible=false;
            //        vm.gridApi.core.refresh();
            //      }
            //    },
            //    {
            //      title: 'Reset Columns',
            //      action: function () {
            //        vm.changeLookupType();
            //      }
            //    }
            //],
            onRegisterApi: function (gridApi) {
                vm.gridApi = gridApi;
                // Register Events
                //gridApi.selection.on.rowSelectionChanged($scope, rowSelectionChanged);
            }
        };

        AdminLookupService.getLookupType(vm.lookupType.value).then(function (data) {
            vm.data = UiGridUtilService.extractTableCellValues(data.tableRows);
            vm.gridOptions.data = vm.data;
            vm.gridOptions.columnDefs = UiGridUtilService.extractColumnDefs(data.tableRows);
        });

        // Handle grid events
        function rowSelectionChanged(row) {
            vm.selectedRow = row.isSelected ? row.entity : false;
        }

        vm.changeLookupType = function () {
            AdminLookupService.getLookupType(vm.lookupType.value).then(function (data) {
                vm.data = UiGridUtilService.extractTableCellValues(data.tableRows);
                vm.gridOptions.data = vm.data;
                vm.gridOptions.columnDefs = UiGridUtilService.extractColumnDefs(data.tableRows);
                vm.gridOptions.exporterCsvFilename = vm.lookupType.value + '.csv';
            });
        };

        /**
         * Add or Edit an item
         * @param {Object} item Optional item if this is an edit operation
         */
        vm.addItem = function (item) {
            ModalRowEdit.open(vm.gridOptions.columnDefs, item).then(function (newItem) {
                vm.gridOptions.data.push(newItem);
            });
        };

        vm.remove = function (item) {
            // Remove an item
        };

        vm.export = function () {
            vm.gridApi.exporter.csvExport(vm.uiGridExporterConstants.ALL, vm.uiGridExporterConstants.ALL);
        };

        /**
         * Workaround to filter on all columns
         * @todo Remove this when ui-grid provides it natively
         */
        vm.refreshData = function (filter) {
            vm.gridOptions.data = vm.data;
            while (filter) {
                var oSearchArray = filter.split(' ');
                vm.gridOptions.data = $filter('filter')(vm.gridOptions.data, oSearchArray[0], undefined);
                oSearchArray.shift();
                filter = (oSearchArray.length !== 0) ? oSearchArray.join(' ') : '';
            }
        };

        
    }]);