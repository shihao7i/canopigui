'use strict';

angular.module('admin.app').controller('LookupAdminController', ['$scope', '$log', 'lookupTypes', 'AdminLookupService',
    function ($scope, $log, lookupTypes, AdminLookupService) {
        var vm = this;

        vm.lookupTypes = lookupTypes;

        // Configure grid
        vm.gridOptions = {
            enableRowSelection: true,
            enableRowHeaderSelection: true,
            enableSelectAll: false,
            enableHorizontalScrollbar: 0,
            enableColumnMenus: false,
            multiSelect: false,
            onRegisterApi: function (gridApi) {
                vm.gridApi = gridApi;
                // Register Events
                gridApi.selection.on.rowSelectionChanged($scope, rowSelectionChanged);
                gridApi.rowEdit.on.saveRow($scope, saveRow);
            }
        };

        // Load default values
        vm.lookupType = vm.lookupTypes[0];
        vm.mySlections = [];

        AdminLookupService.getLookupType('jeopardycodes').then(function (data) {
            vm.gridOptions.data = extractTableCellValues(data.tableRows);
            vm.gridOptions.columnDefs = extractColumnDefs(data.tableRows);
        });

        // Handle grid events
        function rowSelectionChanged(row) {
            vm.selectedRow = row.isSelected ? row.entity : false;
            vm.gridApi.cellNav.scrollTo(row.entity);
        }

        function saveRow(row) {
            // Fired when a row is saved
        }

        vm.changeLookupType = function () {
            AdminLookupService.getLookupType(vm.lookupType.value).then(function (data) {
                vm.gridOptions.data = extractTableCellValues(data.tableRows);
                vm.gridOptions.columnDefs = extractColumnDefs(data.tableRows);
            });
        };

        vm.addItem = function () {
            vm.gridOptions.data.push(angular.copy(vm.gridOptions.data[0]));
            //vm.gridApi.selection.toggleRowSelection(vm.gridOptions.data[vm.gridOptions.data.length - 1]);
        };

        vm.remove = function () {
            // Remove an item
        };

        // help method to build ng-grid's columnDefs property based on meta data column attributes
        function extractColumnDefs(tableData) {
            var uniqueColumns = _.uniq(tableData.rowMetaData.columnList, 'id'),
            // map meta data column defs to the column defs ng-grid expects
                columnDefMap = {
                    id: 'field',
                    displayName: 'displayName'
                };

            var columnDefs = uniqueColumns.map(function (id) {
                var t = {};
                for (var key in columnDefMap) {
                    t[columnDefMap[key]] = id[key];
                }
                ;
                return t;
            });

            // Add cellTemplate
            _.forEach(columnDefs, function(def){
                def.cellTemplate = "<div class=\"ui-grid-cell-contents\" tooltip='{{COL_FIELD}}'>{{COL_FIELD CUSTOM_FILTERS}}</div>";
            });

            return columnDefs;
        }

        // help method to build ng-grid's data property based on meta data row values
        function extractTableCellValues(tableData) {

            var localRowData = [];
            var cellsInRow = [];

            var totalCols = tableData.rowMetaData.columnList.length;
            var totalRows = tableData.rowMetaData.rowValueList.length;

            for (var i = 0; i < totalRows; i++) {

                cellsInRow = tableData.rowMetaData.rowValueList[i].cellValues;

                var obj = {};

                for (var j = 0; j < totalCols; j++) {
                    obj[tableData.rowMetaData.columnList[j]['id']] = cellsInRow[j];
                }

                localRowData.push(obj);
            }

            return localRowData;
        }
    }]);