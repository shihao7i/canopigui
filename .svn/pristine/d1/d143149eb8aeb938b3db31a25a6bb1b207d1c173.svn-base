angular.module('admin.app').controller('TasksController', ['$scope', '$http', '$log', 'TaskSearchService',
                                       function ($scope, $http, $log, TaskSearchService) {
	'use strict';
        
        var vm = this;
        
        init();
        
        function init() {
            
  	    initializeVMVariables();
 	    setupVMMethods();
            
        }
        
        function  initializeVMVariables() {
            
            vm.lookupTypeList = [
                {name: 'Jeopardy Code'},
                {name: 'Rework Code'},                
                {name: 'Carrier Name'},                
                {name: 'Backhual Product'},
                {name: 'Special Application'}                 
            ];
            
            // select Jeopardy Code in the dropdown
            vm.lookupType = vm.lookupTypeList[0];
            
            vm.mySelections = [];
        }
        
                // help method to build ng-grid's columnDefs property based on meta data column attributes
        function extractColumnDefs(tableData) {
            
            var uniqueColumns = _.uniq(tableData.rowMetaData.columnList, 'id'),
                
            // map meta data column defs to the column defs ng-grid expects
            columnDefMap = {
                id: 'name',
                displayName: 'displayName'
            };

            var columnDefs = uniqueColumns.map(function (id) {
                var t = {};
                for (var key in columnDefMap) {
                    t[columnDefMap[key]] = id[key];
                };
                return t;
            });
            
            return columnDefs;
        }
        
                // help method to build ng-grid's data property based on meta data row values
        function extractTableCellValues(tableData) {
            
            var localRowData = [];
            var cellsInRow = [];
            
            var totalCols = tableData.rowMetaData.columnList.length;
            var totalRows = tableData.rowMetaData.rowValueList.length;
            
            for (var i=0; i < totalRows; i++) {
                
                cellsInRow = tableData.rowMetaData.rowValueList[i].cellValues;
                
                var obj = {};
                
                for (var j=0; j < totalCols; j++) {
                    obj[tableData.rowMetaData.columnList[j]['id']] = cellsInRow[j];
                }
                
                localRowData.push(obj);
            }

            return localRowData;
        }
        
        function setupVMMethods() {
            
            vm.mySelections = [];
    
            vm.refresh = function () {
 
                TaskSearchService.getTaskResults().then(function(data) {

                    var tableData = data.tableRows;  

                    vm.myColumnDefs = extractColumnDefs(tableData);
                    vm.myData = extractTableCellValues(tableData);

                    $log.debug(angular.toJson(vm.myColumnDefs));
                    $log.debug(angular.toJson(vm.myData));

                });
            }
            
            // fetch data 
            vm.refresh();
    
            vm.gridOptions = { 
                data:  [{"orderID":"217","orderType":"ETTCSimple","orderStatus":"In Progress","USID":"11665","siadCLLI":"R4B","createdBy":"SNTLCAVS","createdDate":""},{"orderID":"217","orderType":"ETTCSimple","orderStatus":"In Progress","USID":"11665","siadCLLI":"R4B","createdBy":"SNTLCAVS","createdDate":""},{"orderID":"217","orderType":"ETTCSimple","orderStatus":"In Progress","USID":"11665","siadCLLI":"R4B","createdBy":"SNTLCAVS","createdDate":""},{"orderID":"217","orderType":"ETTCSimple","orderStatus":"In Progress","USID":"11665","siadCLLI":"R4B","createdBy":"SNTLCAVS","createdDate":""},{"orderID":"217","orderType":"ETTCSimple","orderStatus":"In Progress","USID":"11665","siadCLLI":"R4B","createdBy":"SNTLCAVS","createdDate":""},{"orderID":"217","orderType":"ETTCSimple","orderStatus":"In Progress","USID":"11665","siadCLLI":"R4B","createdBy":"SNTLCAVS","createdDate":""},{"orderID":"217","orderType":"ETTCSimple","orderStatus":"In Progress","USID":"11665","siadCLLI":"R4B","createdBy":"SNTLCAVS","createdDate":""},{"orderID":"217","orderType":"ETTCSimple","orderStatus":"In Progress","USID":"11665","siadCLLI":"R4B","createdBy":"SNTLCAVS","createdDate":""}],  // ControllerAs convention : http://stackoverflow.com/questions/25210910/ng-grid-with-controller-as-syntax
                columnDefs: [{"name":"orderID","displayName":"Order ID"},{"name":"orderType","displayName":"Order Type"},{"name":"orderStatus","displayName":"Order Status"},{"name":"USID","displayName":"USID"},{"name":"siadCLLI","displayName":"SIAD CLLI"},{"name":"createdBy","displayName":"Created By"},{"name":"createdDate","displayName":"Created Date"}]
            };  
        }
          
//        $scope.myData = [
//           {
//               "firstName": "Cox",
//               "lastName": "Carney",
//               "company": "Enormo",
//               "employed": true
//           },
//           {
//               "firstName": "Lorraine",
//               "lastName": "Wise",
//               "company": "Comveyer",
//               "employed": false
//           },
//           {
//               "firstName": "Nancy",
//               "lastName": "Waters",
//               "company": "Fuelton",
//               "employed": false
//           }
//       ];
//    
}]);
