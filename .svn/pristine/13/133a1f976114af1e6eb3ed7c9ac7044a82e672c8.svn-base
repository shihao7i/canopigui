angular.module('canopi.service').service('UiGridUtilService', function () {
	'use strict';
	
        // auto adjust column widths in ui-grid
        // http://stackoverflow.com/questions/17174096/is-there-a-way-to-auto-adjust-widths-in-ng-grid
        
        this.autoColWidth = function (colDefs, row) {
            
            var totalChars = 0;
            
            for (var i = 0; i < row.columnList.length; i++) {
                totalChars += (new String(row.columnList[i].displayName)).length;
            }
            
            for (var i = 0; i < colDefs.length; i++) {
                var numChars = (new String(colDefs[i].displayName)).length;
                if(totalChars > 100) {
                    colDefs[i].width = ( (numChars / totalChars)  * 200) + "%";
                } else {
                    colDefs[i].width = ( (numChars / totalChars)  * 100) + "%";
                }
            }
            
            return colDefs;
        }
        
        
        
        // helper method to build ng-grid's columnDefs property based on meta data column attributes
        this.extractColumnDefs = function(tableData) {
            var uniqueColumns = _.uniq(tableData.rowMetaData.columnList, 'id'),
            // map meta data column defs to the column defs ng-grid expects
                columnDefMap = {
                    id: 'field',
                    displayName: 'displayName'
                };

            var columnDefs = uniqueColumns.map(function (id) {
                var t = {};
                for (var key in columnDefMap) {
                    t[columnDefMap[key]] = id[key];
                }
                return t;
            });

            // Add cellTemplate
            _.forEach(columnDefs, function (def) {
                def.cellTemplate = "" +
                "   <div ng-if='COL_FIELD.length > 20' class='ui-grid-cell-contents' tooltip='{{COL_FIELD CUSTOM_FILTERS}}'>{{COL_FIELD CUSTOM_FILTERS}}</div>" +
                "   <div ng-if='COL_FIELD.length <= 20' class='ui-grid-cell-contents'>{{COL_FIELD CUSTOM_FILTERS}}</div>";
            });

            return columnDefs;
        }



        // helper method to build ng-grid's data property based on meta data row values
        this.extractTableCellValues = function(tableData) {

            var localRowData = [];
            var cellsInRow = [];

            var totalCols = tableData.rowMetaData.columnList.length;
            var totalRows = tableData.rowMetaData.rowValueList.length;

            for (var i = 0; i < totalRows; i++) {

                cellsInRow = tableData.rowMetaData.rowValueList[i].cellValues;

                var obj = {};

                for (var j = 0; j < totalCols; j++) {
                    obj[tableData.rowMetaData.columnList[j]['id']] = cellsInRow[j];
                }

                localRowData.push(obj);
            }

            return localRowData;
        }
});

